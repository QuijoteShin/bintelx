# snippets/csp.map.conf
# CSP mappings por dominio — INCLUIR EN CONTEXTO http {} de nginx.conf
#
# En el servidor:
#   sudo nano /etc/nginx/nginx.conf
#   Agregar dentro de http {} ANTES de include sites-enabled:
#     include /var/www/bintelx.cifrid.com/bintelx/config/server/snippets/csp.map.conf;

# ── CDNs y servicios externos permitidos ──
# Tailwind
map $uri $csp_cdn_tailwind {
    default "https://cdn.tailwindcss.com";
}

# ── connect-src ──
map $host $csp_connect_src {
    default "'self'";

    # Producción
    ~^(.+\.)?cifrid\.com$              "'self' wss://$host https://www.google-analytics.com https://analytics.google.com https://graph.facebook.com https://analytics.tiktok.com";
    ~^(.+\.)?labtronic\.cl$            "'self' wss://$host https://www.google-analytics.com https://analytics.google.com https://graph.facebook.com https://analytics.tiktok.com";

    # Desarrollo
    ~^(.+\.)?dev\.local$               "'self' ws://$host wss://$host";
}

# ── script-src ──
map $host $csp_script_src {
    default "'self' 'unsafe-inline' 'unsafe-eval'";

    # Producción — CDNs + analytics + pixels
    ~^(.+\.)?cifrid\.com$              "'self' 'unsafe-inline' 'unsafe-eval' https://cdn.tailwindcss.com https://www.googletagmanager.com https://www.google-analytics.com https://connect.facebook.net https://analytics.tiktok.com";
    ~^(.+\.)?labtronic\.cl$            "'self' 'unsafe-inline' 'unsafe-eval' https://cdn.tailwindcss.com https://www.googletagmanager.com https://www.google-analytics.com https://connect.facebook.net https://analytics.tiktok.com";

    # Desarrollo
    ~^(.+\.)?dev\.local$               "'self' 'unsafe-inline' 'unsafe-eval' https://cdn.tailwindcss.com";
}

# ── style-src ──
map $host $csp_style_src {
    default "'self' 'unsafe-inline' https://cdn.tailwindcss.com https://fonts.googleapis.com";
}

# ── img-src ──
map $host $csp_img_src {
    default "'self' data: blob: https://www.google-analytics.com https://www.googletagmanager.com https://www.facebook.com https://*.tiktok.com https://*.instagram.com";
}

# ── media-src ──
map $host $csp_media_src {
    default "'self' data: blob:";
}

# ── font-src ──
map $host $csp_font_src {
    default "'self' https://fonts.gstatic.com";
}

# ── frame-src ──
map $host $csp_frame_src {
    default "'self' https://www.google.com https://www.facebook.com https://www.tiktok.com https://www.instagram.com";
}

# ── default-src ──
map $host $csp_default_src {
    default "'self'";
}
